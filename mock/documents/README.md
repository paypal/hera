# HERAMOCK
##### Table of Contents
[Introduction](#Introduction)  
[Target Audience](#Target-Audience)  
[What are we mocking here](#What-are-we-mocking-here)   
[Control Port APIS](#Control-Port-APIS)   
[Features](#Features)  
[Setup and Integration](#Setup-and-Integration)

## Introduction
[HERA](https://github.com/paypal/hera#readme) (High Efficiency Reliable Access to data stores, Open sourced as HERA by PayPal) is a key enabler for scaling and
improving availability of relational (Oracle/MySQL/Postgres) databases at PayPal.

*heramock* (otherwise called**heramock**) is an custom docker app which helps to mock all the database
operation handled via HERA.

### Target Audience

    I want to isolate my application's functional test from all database operations(hera based MySQL/Oracle).
    I want to see every data passed between my application and database (say for debugging)
    I want to simulate negative cases related to database such as query timeout, transaction failure, commit failure ...
    I want to do load & performance testing on my application and avoid database related operations skewing my report?

### What are we mocking here

1. All database operations done via HERA.

2. What are the database operations my application does?

    1. Select/Update/Insert/PLSQL
    2. Database Transactions
    3. Commit/Rollback

## Basics

1. **heramock** sits between application and HERA.
2. Ports Exposed
    1. It listens to all the ports that are mocked
        1. Example: 10101
    2. Also, it listens to one control port **13916** where it exposes various API for developers to use
3. **heramock** can be deployed in linux/windows/mac/testenv in QA/Dev environments
4. Mocking is done on request basis in our case request is select/update/insert etc ..
5. Mocking instruction has to be sent to **heramock** through api exposed on its control port (13916)
6. Without any specific instruction **heramock** act as pass through layer, logging all the request/response through it.
7. Default backend for **heramock** is msmaster.
    1. So in our example just deploying **heramock** by mocking 10101
    2. Will act as proxy and logging all the communication between app and hera
8. heramockHelper is a java class exposed by heramockclient JAR. This will help developers to talk to apis exposed by **heramock** in control port.
9. Mock works on key value pair.
    1. Key is the identifier of the request.
        1. In case of SQL it will be SQL comment.
        2. In case of flow it will be corrid.
        3. Sometimes there are special keys more than one keys separated by ":".
    2. Value is the mock response the code is expecting. This response needs to be in specific format.


## Control Port APIS
| API             | Explanation                                                                                                                                                                                                                                                                                                                                                                                                                           | curl command                                                                                                                                                                                | heramockHelper                                                                                                                                                                                                          |
|-----------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| mock/logs       | Logs contains all the request and response that happened in last 24 hours between application and all mocked hera<br/><br/> We can add filter to get only certain data, filters can be epoc time, corrid, port or any part of query                                                                                                                                                                                                    | `curl "localhost:13916/mock/logs"`<br/><br/>`curl "localhost:13916/mock/logs?get=*15106*`<br/><br/>`curl "localhost:13916/mock/logs?get=*EMailMap._PrimaryKeyLookup.-2*`                    | `List<MockLog> heramockHelper.mockLogs("EMailMap._PrimaryKeyLookup.-2");<br/><br/>List<MockLog> heramockHelper.mockLogs();` <br/><br/>returns List of MockLog Object which can be found in heramockclient jar             |
| mock/rawlogs    | Raw Logs Encoded in netstring format. Mostly used for **heramock** developers for debugging issues                                                                                                                                                                                                                                                                                                                                     | `curl "localhost:13916/mock/rawlogs"`                                                                                                                                                       | No Interface is present                                                                                                                                                                                                |
| mock/list       | List of mock instruction which is currently active in **heramock**.<br/><br/> Each mock instruction is key-value pair.<br/><br/> Key identifies the request and value contains instruction to mock on how to respond.                                                                                                                                                                                                                  | `curl "localhost:13916/mock/list"`                                                                                                                                                          | `Map<String, String> heramockHelper.listMock()`<br/>                                                                                                                                                                    |
| mock/add        | This api allows developer to add new mock instruction. <br/><br/>Mock instruction is key-value pair, with key being request and value as instruction to mock. <br/> <br/>There are special keys such as heramock_SERVERIP which tells what is mocks backend server. <br/> <br/>By default it is msmaster<br/> <br/> by default all mock instruction becomes invalid after 120 seconds, which can be adjusted during adding the mock | `curl "localhost:13916/mock/add" -d 'QueryName=QueryAction'`<br/><br/>`curl "localhost:13916/mock/add" -d 'QueryName=QueryAction&expire_time_in_sec=180'`                                   | `boolean addMock(String key, String value, int nThOccurance, int timeout, int delayInMs)`<br/><br/>NOTE: addmock has more number of interface to satisfy multiple features which we will explain in feature list below |
| mock/delete     | This api allows user to delete already existing mock, it always will return ok. <br/> <br/> It takes key as input, key is the request identifier.                                                                                                                                                                                                                                                                                     | `curl -DELETE "localhost:13916/mock/delete?key=QueryName"`                                                                                                                                  | `boolean removeMock(String key)`                                                                                                                                                                                       |
| mock/getreqresp | This api is used to capture request/responses for a given correlation id.<br/>Mock has a feature on capturing all the request & response for a given corrid and use addMock to replay them for a new run                                                                                                                                                                                                                              | `curl "localhost:13916/mock/add" -d 'CorrdId=CAPTURE'` //for starting capture <br/><br/> `curl "localhost:13916/mock/getreqresp?key=CorrId"` //response will come as string                 | `boolean addMock(key, heramockAction.CAPTURE)` // for starting capture<br/><br/> `void endRRCapture(String key, String outFile)` // for capturing all request and response in given fileName.                           |
| mock/flush_logs | some times mocks logs will be delayed as it is done asynchronously. <br/><br/>This api will flush the mock logs. This is experimental api                                                                                                                                                                                                                                                                                             | `curl "localhost:13916/mock/flush_logs?port=15106"`                                                                                                                                         | `boolean flush_logs(String port)`                                                                                                                                                                                      |
| mock/status     | This api is to validate replay in capture-replay use case. <br/> Returns "success" when replay succeeds and "failure" with more debug logs when it fails                                                                                                                                                                                                                                                                              | `curl "localhost:13916/mock/status?key=corrid"` // returns success or failed:<details about query where it failed"                                                                          | `String getReplayStatus(String key)` // returns success or failed:<details about query where it failed"                                                                                                                |
| mock/info       | This api gives information about the mock such as whats the backend server, what are all hera it is mocking etc                                                                                                                                                                                                                                                                                                                        | `curl "localhost:13916/mock/info"`                                                                                                                                                          | Not implemented                                                                                                                                                                                                        |
| mock/reload     | This api restarts mock. This is required certain cases such as simulating connection level mock (as connections are cached in app layer). <br/><br/> Also this is used internally when we change the backend server, calling this api re-triggers all the connections to server again                                                                                                                                                 | `curl "localhost:13916/mock/reload"`                                                                                                                                                        | `boolean reloadMock()`                                                                                                                                                                                                 |
| mock/traffic    | This api gives traffic graph or raw data based on request, it stores last 10 mins traffic volume.<br/> <br/> This is used to understand how many connections are being used by DAL/HERA/Mock. Mostly used in LnP Testing                                                                                                                                                                                                               | `curl "localhost:13916/mock/traffic?port=1010&readable=false&html=true"` <br/> <br/>// port tells which hera we are looking at, html gives graph version and readable gives pretty formatted | Not implemented                                                                                                                                                                                                        |
| mock/heartbeat  | This api check if the mock is up and running                                                                                                                                                                                                                                                                                                                                                                                          | `curl "localhost:13916/mock/heartbeat"`                                                                                                                                                     | Not implemented                                                                                                                                                                                                        |
| mock/test       | This api runs all the unit test and verifies if mock build is good.<br/><br/>  In development                                                                                                                                                                                                                                                                                                                                         | `curl "localhost:13916/mock/test"`                                                                                                                                                          | Not implemented                                                                                                                                                                                                        |


## Features

| Feature                                   | Explanation                                                                                                                                                                                                                                                                                                                                                                              | Example Code                                                                                                                                                                                                                                                                                                                                                                                                                          |
|-------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Backed By                                 | by default heramock is backed by localhost, we can change this to any end point to given ip/name. <br/><br/> We can also get current server ip.<br/><br/> We can have port/hera specific backend                                                                                                                                                                                         | `boolean setServerIp(String newIp)` // internally it calls addMock addMock("heramock_SERVERIP", newIp)<br/> <br/> && `String getServerIp()` && <br/> <br/> `boolean setServerIp(String newIp, String ports)` // ports are comma separated - <br/> <br/>internally it calls addMock - `addMock("PORT_heramock_SERVERIP", newIp + ":" + ports)`                                                                                     |
| Change Mock IP                            | by default heramockHelper code thinks heramock is running the same box where the code is being executed, <br/> <br/>so calls such as addMock, listMock calls local host.<br/><br/> In case of heramock deployed in testenv user needs to change it to testenv ip (using mako.hostname)                                                                                                   | `void setMockIP(String mIP)` && `String getMockIP()` to get it back  && `boolean revertServerIp()` reverts to previous stored ServerIp                                                                                                                                                                                                                                                                                                |
| Enable/Disable heramock logs               | by default logs and rawlogs are in info mode. <br/><br/> Writing Log takes some processing, but might not be noticed on normal testing, but it will be clear on LnP testing. There is interface to disable them.                                                                                                                                                                         | `void disableLogging()` && `void enableLogging()`<br/> <br/> internally it calls add Mock `addMock(JDBCMockConst.DISABLE_LOG, "true", 1, -1)` && `removeMock(JDBCMockConst.DISABLE_LOG)`                                                                                                                                                                                                                                              |
| Random Failure                            | This use case servers random failure for given request. <br/> <br/>We could select a % of request to have failure response.<br/> <br/> Internally it does addMock in certain format <br/> <br/>addMock(key, "FOREVER_RANDOM NEXT_COMMAND_REPLY " + failurePercentage + ADD_MOCK_CONSTRAINT + failureSampling + ADD_MOCK_CONSTRAINT + successValue + ADD_MOCK_CONSTRAINT + failureValue); | `boolean addRandomFailureMock(String key, String successValue, String failureValue, int failurePercentage, int failureSampling)` <br/> <br/>// String value for success has to be internal structure that mock can understand.<br/> <br/> There are other overloaded methods with predefined failure percentage (25%) and fine tuned sampling for failure injection                                                                   |
| SSL Failure during connect                | We could simulate SSL failure using this method. <br/> <br/>Internally it calls add mock as addMock(heramockAction.ACCEPT, heramockAction.SIMULATE_AUTH_FAILURE, 1);<br/> <br/> it is also available in port level. Meaning we could target only one hera.                                                                                                                               | `boolean simulateCustomAuthConnectionFailure()`. Note these are connection level mock if we start the app and set this only new connections will get affected, old connection in connection pool cache are already in connected state. <br/> <br/>We could use heramock reload option to kill the existing connection, to simulate new connect failure with SSL <br/> <br/> `boolean simulateCustomAuthConnectionFailure(String port)` |
| Connection Timeout                        | We could simulate connection timeout same as SSL failure, <br/> <br/>these are applicable only for new connection and we can do port level connection timeout too. Internally it calls addMock(heramockAction.ACCEPT, heramockAction.CONNECTION_TIMEOUT, 1);                                                                                                                             | `boolean simulateConnectionTimeout()` && `boolean simulateConnectionTimeout(int timeout)` && `boolean simulateConnectionTimeout(String port)`                                                                                                                                                                                                                                                                                         |
| Clock Skew                                | We could simulate clock skew. Both general and port level mock is available. <br/> <br/> Internally it calls addMock(heramockAction.ACCEPT + ":" + port, heramockAction.SIMULATE_CLOCK_SKEW, 1);                                                                                                                                                                                         | `boolean simulateConnectionClockSkew()` && `boolean simulateConnectionClockSkew(String port)`                                                                                                                                                                                                                                                                                                                                         |
| Connection Level Mock                     | SSL Failure, Connect Timeout, Clock Skew are all called as connection level mock and to remove the mock we need remove mock.  <br/> <br/>Internally it calls removeMock removeMock(heramockAction.ACCEPT + ':' + mockKey);                                                                                                                                                               | `boolean removeConnectionMock()` && `boolean removeConnectionMock(String mockKey)`                                                                                                                                                                                                                                                                                                                                                    |
| Request & Response Capture                | We could capture request and response for specific query or set of queries under same correlation id. <br/> <br/> We need two calls here one to start capture and another to end. Underlying it is simple add Mock - addMock(key, heramockAction.CAPTURE);                                                                                                                               | `boolean startRRCapture(String key)` && `void endRRCapture(String key, String outFile)` // since response are too huge we get output file name and write the response there instead of returning it  <br/> <br/> SQL capture - `JSONObject getCapturedSQLResponse(String key, Object[] objects)` && `Map<String, String> getCapturedSQLResponse(String key)`                                                                          |
| Replay captured response                  | We could use the captured response and play for same query again or same flow with new corrid. <br/> <br/> We can also get status of replay if it has completed correctly. In case of success we get "success" as response and failure time we get details on failure sql                                                                                                                | `boolean replayCaptured(String key, String fileName)` && `boolean replayCaptured(String key, String fileName, int timeout)`  <br/> <br/> `String getReplayStatus(String key)`                                                                                                                                                                                                                                                         |
| Add Mock                                  | Simple Add mock as many over loaded methods. Add Mock can have simple String as value or any POJO/Entity Object to respond                                                                                                                                                                                                                                                               | `boolean addMockForEver(String key, String/Object value)` // mock does not expire<br/> <br/> `boolean addMock(String key, String value/Object)` // simple add Mock expires in 100 sec <br/> <br/> `boolean addMock(String key, String value/Object, int nThOccurance)` // if there are more time query with key (query comment) comes the mock nThOccurance (default is 1). -1 is forever, 2 is for second, -3 is for first three     |
| Add Mock Cont...                          | Simple Add mock as many over loaded methods. Add Mock can have simple String as value or any POJO/Entity Object to respond                                                                                                                                                                                                                                                               | `addMock(String key, String value/Object, int nThOccurance, int timeout)` // mock expires in timeout seconds - default is 120 seconds <br/> <br/> `boolean addMock(String key, String value/Object, int nThOccurance, int timeout, int delayInMs)` // delay before responding - default is 0 mill sec<br/> <br/>                                                                                                                      |
| Mock Commit and Rollback                  | We can mock commit and rollback. Key for commit would be query running before commit or corrid                                                                                                                                                                                                                                                                                           | `boolean mockCommitForEver() && mockRollbackForEver()`                                                                                                                                                                                                                                                                                                                                                                                |
| Converting POJO to String for Object Mock | heramock gets String as mock value but users have Java pojo or entity object.  <br/> <br/>There is addMock overloaded method which accepts POJO/Entity.<br/> <br/> There is also method to convert POJO to String format in case there is custom need                                                                                                                                    | `String getObjectMock(Object objectToRespond, boolean noDataFound, int delayMs)`                                                                                                                                                                                                                                                                                                                                                      |
| Load Based Mock                           | Load Based Mock takes array of LoadBasedMock Objects which contains minRange, maxRange, successResponse, failureResponse, failurePercentage and key to mock. <br/> <br/>This mock kicks in when number of parallel query execution is between minRange and MaxRange. <br/> <br/>And based on % fail and success responses are returned                                                   | `boolean loadBasedMock(String port, List<LoadBasedMock> loadBasedMocks)`                                                                                                                                                                                                                                                                                                                                                              |
| Remove Mock                               | Remove the previously set Mock                                                                                                                                                                                                                                                                                                                                                           | `boolean removeMock(String key)`                                                                                                                                                                                                                                                                                                                                                                                                      |

## Setup and Integration

### How to start and stop **heramock** in laptop/desktop

#### Basic Steps
1. Start **heramock** in laptop with hera's which needed to be mocked as parameter
2. Run the test case to see the queries in mock/logs
3. Run the app and hit the endpoint or use FT to see all the queries passed through mock

